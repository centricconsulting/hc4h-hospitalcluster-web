(function(){ovi.provide("nokia.maps.clustering.ColorizerTheme");
(function(h){var g=h.util.c;h.clustering.ColorizerTheme=new ovi.Class({initialize:function(){},getClusterPresentation:function(f){var f=f.getPoints?f.ud:f,c=f.length,a,j;a=(16777216*Math.random()|0).toString(16);j="#"+a+(a.length==5?"f":"");var b=new h.map.Container;for((!f||c==0)&&g("Please provide at least one data point");a=f[--c];)b.objects.add(new h.map.StandardMarker(a,{brush:{color:j}}));return b},getNoisePresentation:function(f){return new h.map.StandardMarker(f,{brush:{color:"#CCCCCC"}})}})})(nokia.maps);
ovi.provide("nokia.maps.clustering.Noise");(function(h){h.clustering.Noise=new ovi.Class({initialize:function(g){this.Mj=g},isAdded:!1,Mj:null,ug:null,je:null,getCoordinate:function(){if(!this.Yn)this.Yn=new h.geo.Coordinate(this.Mj.latitude,this.Mj.longitude);return this.Yn},getIcon:function(g,f){if(!this.je||f)this.je=g.getNoisePresentation(this.Mj);return this.je}})})(nokia.maps);ovi.provide("nokia.maps.clustering.Cluster");
(function(h){h.clustering.Cluster=new ovi.Class({initialize:function(g){this.ud=g?[g]:[]},isAdded:!1,ud:null,ag:null,je:null,getBounds:function(){if(!this.ag)this.ag=h.geo.BoundingBox.coverAll(this.ud);return this.ag},getPoints:function(){return this.ud},getSize:function(){return this.ud.length},push:function(g){if(this.ag!==null)this.ag=null;this.ud.push(g)},getIcon:function(g,f){if(!this.je||f)this.je=g.getClusterPresentation(this);return this.je}})})(nokia.maps);ovi.provide("nokia.maps.clustering.ITheme");
ovi.provide("nokia.maps.clustering.IClusterPoint");ovi.provide("nokia.maps.clustering.Index");
(function(h){function g(a,b){for(var c=b.length,e,a=new ovi.Array(a);e=b[--c];)j(a,e)==-1&&a.push(e);return a}var f=h.util,c=f.RTree,a=f.RTreeRecord,j=ovi.Array.indexOf,b=f.c,e={algorithm:c.QUADRATIC_PARTITIONING,min:12,max:32};h.clustering.Index=new ovi.Class({initialize:function(a){var d,f,a=a||{};d=a.max||e.max;f=a.min||e.min;a=a.algorithm||e.algorithm;(typeof d!="number"||d<2)&&b("The given parameter 'max' is not a number, or less than 2! max is "+d);(typeof f!="number"||f>d/2||f<1)&&b("The given parameter 'min' is not a number, or is not at least 2 times smaller than max! min is"+
f);(typeof a!="number"||a>3||a<0)&&b("The given algorithm "+a+" is not supported. Please specify value from 0 to 3.");this.rg={max:d,min:f,algorithm:a};this.A=new c(this.rg.algorithm,this.rg.max,this.rg.min);this.kb={}},add:function(b){var d;d=b.x;var c=b.y;d=new a(d-0.5,c-0.5,d+0.5,c+0.5);this.A.add(d);d.$coordinate=b;this.kb[b]=d},remove:function(a){(!a||a.x==void 0||a.y==void 0)&&b("Invalid coordinate");this.kb[a]!=void 0&&(this.A.remove(this.kb[a]),delete this.kb[a])},clean:function(){this.A.removeAll()},
getNeighborhood:function(a,b,c){var e=a.x,f=a.y,a=e+b;e-=b;var j=f-b,b=f+b;if(a>c)return g(this.A.search(e,c,j,b),this.A.search(0,a-c,j,b));else if(e<0)return g(this.A.search(0,a,j,b),this.A.search(c+e,c,j,b));return this.A.search(e,a,j,b)}})})(nokia.maps);ovi.provide("nokia.maps.clustering.RectangleTheme");
(function(h){var g=h.util.c,f=h.gfx.GraphicsImage,c=h.map.Rectangle;h.clustering.RectangleTheme=new ovi.Class({initialize:function(){this.cm=new f(function(a){a.beginImage(22,22,"ClusteringNoisePoint");a.set("lineWidth",2);a.set("strokeColor","#ffffff");a.set("fillColor","#1080DD");a.drawEllipse(10,10,10,10);a.stroke();a.fill()})},getClusterPresentation:function(a){var f=a.getSize?a.getSize():a.length;(!a||f==0)&&g("Please provide at least one data point");return new c(a.getBounds?a.getBounds():h.geo.BoundingBox.coverAll(a),
{pen:{strokeColor:"#000",lineWidth:1},brush:{color:"#CC2A"}})},getNoisePresentation:function(a){return new h.map.Marker(a,{icon:this.cm})}})})(nokia.maps);ovi.provide("nokia.maps.clustering.MarkerTheme");
(function(h){var g=h.util.c,f=h.gfx.GraphicsImage,c=h.geo.BoundingBox.oc,a=h.clustering.MarkerTheme=new ovi.Class({initialize:function(c){this.ve=c==a.POSITION_CENTER||c==a.POSITION_FIRST||c==a.POSITION_WEIGHT_CENTER?c:"weight";this.cm=new f(function(a){a.beginImage(14,14,"ClusteringNoisePoint");a.set("lineWidth",2);a.set("strokeColor","#FFFFFF");a.set("fillColor","#1080DD");a.drawEllipse(2,2,10,10);a.stroke();a.fill()})},Statics:{POSITION_CENTER:"center",POSITION_FIRST:"first",POSITION_WEIGHT_CENTER:"weight",
getColor:function(a){return a<10?"#76D100":a<25?"#FF6900":a<50?"#F03C00":"#B50015"}},Yq:function(a){var b=a.length,e=0,f=0,d=0,g=0,h,m;m=!1;for(var p,r;h=a[--b];){p=parseFloat(h.value);if(isNaN(p)||p<0)p=1;m=h.latitude;h=h.longitude;e+=m*p;f+=(h<0?h+360:h)*p;d+=h*p;g+=p;r=!r?[m,h,m,h]:c(r,[m,h,m,h])}m=r[1]>r[3];h=(m?f:d)/g;return{latitude:e/g,longitude:m&&h>180?h-360:h}},Xq:function(a){return h.geo.BoundingBox.coverAll(a).getCenter()},getClusterCoordinate:function(c){c=c.getSize!=null?c.ud:c;return this.ve==
a.POSITION_WEIGHT_CENTER?this.Yq(c):this.ve==a.POSITION_CENTER?this.Xq(c):c[0]},getClusterPresentation:function(c){var b,e,l=c.getSize!=null,d=l?c.getSize():c.length,l=this.getClusterCoordinate(l?c.ud:c),n=a.getColor(d);(!c||d==0)&&g("Please provide at least one data point");c=(d+"").length;b=c*2+4;e=(c==1?8:c*3+5)*2+b*2;return new h.map.Marker(l,{icon:new f(function(a){a.beginImage(e,e,"Cluster");a.set("fillColor",n+"30");a.drawEllipse(0,0,e,e);a.fill();a.set("fillColor",n);a.drawEllipse(b,b,e-b*
2,e-b*2);a.fill();a.set("font","12px tahoma");a.set("fillColor","#ffffff");a.set("textAlign","center");a.fillText(d,e/2,e/2+4.5)}),anchor:{x:e/2,y:e/2}})},getNoisePresentation:function(a){return new h.map.Marker(a,{icon:this.cm,anchor:{x:7,y:7}})}})})(nokia.maps);ovi.provide("nokia.maps.clustering.ClusterProvider");
(function(h){function g(a,b){typeof a!="number"&&(a=parseInt(a,10));return isNaN(a)||a<b?b:a}var f=h.util,c=Math.max,a=Math.min,j=f.Coroutine,b=h.clustering,e=ovi.Array.indexOf,l={eps:50,min:0,max:20,minPts:1,index:null,theme:new b.MarkerTheme},d=b.Index,n=f.c,k=b.ClusterProvider=new ovi.Class({Extends:h.map.provider.Provider,Mixins:[f.OObject],initialize:function(b,e){var f;this.isValidDisplay(b)||n("Display is not provided.");e=ovi.extend(l,e||{});this.Qi=g(e.eps,10);this.Yl=g(e.minPts,1);this.setTheme(e.theme);
this.min=c(g(0,e.min),l.min);this.max=a(g(0,e.max),l.max);this.label="Clustering";this.description="Manages markers and spatial objects and creates clusters out of them.";this.kb=[];this.og=[];this.oh=[];this.q=b;this.sa=new h.map.Container;b.objects.add(this.sa);f=this.q.baseMapType.width;this.vr=this.q.baseMapType.projection.latLngToMapPoint;this.Yp=30-Math.log(f)/Math.log(2);this.Ys=f*(1<<this.Yp);e.index&&!(e.index instanceof d)&&n("Provided index data structure is invalid.");this.index=e.index?
e.index:new d;this.addAll(e.dataPoints||[]);this.oq();this.set("state",k.STATE_INITIAL)},Statics:{STATE_INITIAL:"initial",STATE_STARTED:"started",STATE_CLUSTERED:"clustered",STATE_READY:"ready"},sa:null,q:null,mt:null,qd:!1,cluster:function(){var a=this.q.zoomLevel,b;this.state==k.STATE_STARTED&&this.invalidate();this.qd=!0;a<this.min||a>this.max?(this.invalidate(),this.sa.objects.clear(),this.kd=a,this.set("state",k.STATE_CLUSTERED)):(this.set("state",k.STATE_STARTED),b=this.Iq(this.kb,this.index?
this.Qi*(1<<this.Yp-a):this.Qi,this.Yl),this.og=b.clusters,this.oh=b.noise,this.set("state",k.STATE_CLUSTERED),this.kd=a,this.Jm(!0))},isValidDisplay:function(a){return a&&a instanceof h.map.Display},Jm:function(a){var b=this.sa.objects;a&&b.clear();this.If=this.q.getViewBounds();this.op=this.ps(this,a)},ps:j.create("nokia.maps.clustering.ClusterProvider#_renderingCo",function(a){var b=a.that,d,c=b.theme,e=b.sa.objects,f=a.arguments[1],g=a.i,h;if(!a.isNoiseRendered){for(g=g==void 0?b.oh.length:g;d=
b.oh[--g];){if((!d.isAdded||f)&&b.If.contains(d.getCoordinate()))(h=d.getIcon(c,f))&&e.add(h),d.isAdded=!0;a.i=g;if(j.shallYield())return j.yield();else if(g%30===0)return j.sleep(10)}a.isNoiseRendered=!0}if(g<0||g==void 0)g=b.og.length;for(;d=b.og[--g];){if((!d.isAdded||f)&&b.If.intersects(d.getBounds()))(h=d.getIcon(c,f))&&e.add(h),d.isAdded=!0;a.i=g;if(j.shallYield())return j.yield();else if(g%10===0)return j.sleep(10)}b.set("state",k.STATE_READY)},{useAnimationFrame:!0},"that","forceCreateIcons"),
Iq:function(a,d,c){var e,f=a.length,j,g=[],h=[],k;for(e=0;e<f;e++)if(k=a[e],!k.visited)k.visited=!0,j=this.kp(k,d,a),j.length-1<c?k.noise=!0:g.push(this.Qq(k,j,d,c,a));for(e=0;e<f;e++)k=a[e],k.noise&&h.push(new b.Noise(k)),delete k.cluster,delete k.visited,delete k.noise;return{clusters:g,noise:h}},Qq:function(a,d,c,e,f){var e=0,j,g=[],d=[d],h;a.cluster=!0;for(g=new b.Cluster(a);e<d.length;){h=d[e];for(a=h.length;h[--a];){j=h[a];if(j.$coordinate)j=j.$coordinate;if(!j.visited)j.visited=!0,d.push(this.kp(j,
c,f));if(j.noise||!j.cluster)j.cluster=!0,g.push(j)}e++}return g},kp:function(a,b,d){var c=d.length,e=[],f;if(this.index)return this.index.getNeighborhood(a,b,this.Ys);else for(b=Math.pow(b,2);f=d[--c];)Math.pow(a.x-f.x,2)+Math.pow(a.y-f.y,2)<=b&&e.push(f);return e},alterIndexRebuild:function(a){var b=this.kb.length;if(a)this.index=a;for(this.index.clean();b--;)this.index.add(this.kb[b])},invalidate:function(){if(this.qd)this.set("state",k.STATE_INITIAL),this.og=[],this.oh=[];this.op&&j.kill(this.op)},
oq:function(){function a(){e&&clearTimeout(e);if(b.qd&&(d=b.q.getViewBounds(),!b.If||c||!d.topLeft.equals(b.If.topLeft)||!d.bottomRight.equals(b.If.bottomRight)))b.If=d,b.kd!=b.q.zoomLevel||c?(b.invalidate(),b.cluster()):b.Jm(),c=!1}var b=this,d,c=!1,e;b.q.addObserver("zoomLevel",function(){b.qd&&(c=!0,b.sa.objects.clear(),e&&clearTimeout(e),e=setTimeout(function(){a()},1E3))});b.q.addListener("mapviewchangeend",function(){a()});b.addObserver("theme",function(){b.qd&&b.Jm(!0)})},add:function(a){var b;
this.invalidate();this.kb.push(a);if(this.index)b=this.vr(a.latitude,a.longitude),a.x=b.x,a.y=b.y,this.index.add(a)},addAll:function(a,b){var d=a.length;for(this.invalidate();d--;)this.add(a[d]);b&&b()},remove:function(a){var b=a?e(this.kb,a):-1;b>=0&&(this.invalidate(),this.kb.splice(b,1));this.index&&this.index.remove(a)},clean:function(){this.invalidate();this.kb=[];this.sa.objects.clear();this.index&&this.index.clean();this.qd=!1;this.set("state",k.STATE_INITIAL)},destroy:function(){this.clean()},
ut:function(a,b){var d;if(a){this.invalidate();for(d=a.length;d--;)this.remove(a[d])}else this.clean();b&&b()},getDataLength:function(){return this.kb.length},numberOfClusters:function(){this.qd||n("Clusters are not available yet. Did you forgot to call cluster method before?");return this.og.length},numberOfNoisePoints:function(){this.qd||n("Clusters are not available yet. Did you forgot to call cluster method before?");return this.oh.length},setEps:function(a){this.Qi=g(a,10);this.invalidate()},
getEps:function(){return this.Qi},setMinPts:function(a){this.Yl=g(a,1);this.invalidate()},getMinPts:function(){return this.Yl},setTheme:function(a){(!a||!a.getClusterPresentation||!a.getNoisePresentation)&&n("Provided theme does not conform to the ITheme interface.");this.set("theme",a)}})})(nokia.maps);ovi.provide("nokia.maps.clustering._packaging.package-clustering");})();